version: '3'

vars:
  HYPERSHIFT_NAMESPACE: '{{.HYPERSHIFT_NAMESPACE | default "hypershift"}}'
  DNS_ZONE_RG: '{{.PERSISTENT_RG_NAME}}'
  EXTRN_DNS_ZONE_NAME: '{{.PARENT_DNS_ZONE}}'
  DNS_CREDS_FILE: 'azure_mgmt.json'

tasks:
  # === VERIFICATION ===

  verify-access:
    desc: Verify management cluster access and permissions
    cmds:
      - echo "Verifying management cluster access..."
      - oc cluster-info
      - |
        if oc auth can-i '*' '*' 2>/dev/null | grep -q "yes"; then
          echo "✓ Cluster-admin permissions confirmed"
        else
          echo "❌ Cluster-admin permissions required"
          exit 1
        fi

  check-capacity:
    desc: Check management cluster resource availability
    cmds:
      - echo "Checking node capacity..."
      - oc top nodes || echo "⚠ metrics-server not available"
      - echo ""
      - echo "Note{{":"}} Each hosted cluster needs approximately{{":"}}"
      - echo "  - 4 CPU cores"
      - echo "  - 8 GB memory"

  # === EXTERNAL DNS SETUP ===

  create-dns-sp-azure:
    desc: Create Azure service principal for External DNS
    internal: true
    preconditions:
      - sh: test -n "{{.PARENT_DNS_ZONE}}"
        msg: "PARENT_DNS_ZONE not set"
      - sh: test -n "{{.PERSISTENT_RG_NAME}}"
        msg: "PERSISTENT_RG_NAME not set"
      - sh: test -n "{{.SUBSCRIPTION_ID}}"
        msg: "SUBSCRIPTION_ID not set"
      - sh: test -n "{{.TENANT_ID}}"
        msg: "TENANT_ID not set"
    status:
      - test -f .sp-output.json
    cmds:
      - echo "Creating service principal for External DNS..."
      - az ad sp create-for-rbac --name "hypershift-external-dns-{{.PREFIX}}" --role "DNS Zone Contributor" --scopes "/subscriptions/{{.SUBSCRIPTION_ID}}/resourceGroups/{{.DNS_ZONE_RG}}" > .sp-output.json

  create-dns-sp:
    desc: Create service principal credentials file for External DNS
    internal: true
    deps: [create-dns-sp-azure]
    vars:
      SP_APP_ID:
        sh: jq -r '.appId' .sp-output.json
      SP_PASSWORD:
        sh: jq -r '.password' .sp-output.json
    status:
      - test -f {{.DNS_CREDS_FILE}}
    cmds:
      - |
        jq -n \
          --arg tenantId "{{.TENANT_ID}}" \
          --arg subscriptionId "{{.SUBSCRIPTION_ID}}" \
          --arg resourceGroup "{{.DNS_ZONE_RG}}" \
          --arg aadClientId "{{.SP_APP_ID}}" \
          --arg aadClientSecret "{{.SP_PASSWORD}}" \
          '{tenantId: $tenantId, subscriptionId: $subscriptionId, resourceGroup: $resourceGroup, aadClientId: $aadClientId, aadClientSecret: $aadClientSecret}' > {{.DNS_CREDS_FILE}}
      - chmod 600 {{.DNS_CREDS_FILE}}
      - rm -f .sp-output.json
      - echo "✓ Created {{.DNS_CREDS_FILE}}"

  create-dns-secret:
    desc: Create Kubernetes secret for External DNS
    internal: true
    deps: [create-dns-sp]
    preconditions:
      - sh: test -f {{.DNS_CREDS_FILE}}
        msg: "DNS credentials file not found: {{.DNS_CREDS_FILE}}"
    cmds:
      - echo "Creating azure-config-file secret in default namespace..."
      - oc delete secret azure-config-file -n default --ignore-not-found
      - oc create secret generic azure-config-file -n default --from-file={{.DNS_CREDS_FILE}}
      - echo "✓ Created secret azure-config-file"

  # === OPERATOR INSTALLATION ===

  install:
    desc: Install HyperShift operator WITHOUT External DNS (simple mode)
    vars:
      IMAGE_FLAG: '{{if .HYPERSHIFT_IMAGE}}--hypershift-image={{.HYPERSHIFT_IMAGE}}{{end}}'
      NS_FLAG: '{{if ne .HYPERSHIFT_NAMESPACE "hypershift"}}--namespace={{.HYPERSHIFT_NAMESPACE}}{{end}}'
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: command -v hypershift
        msg: "hypershift CLI not found"
    status:
      - oc get deployment operator -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
    cmds:
      - echo "Installing HyperShift operator (without External DNS)..."
      - hypershift install --pull-secret {{.PULL_SECRET}} --limit-crd-install azure {{.IMAGE_FLAG}} {{.NS_FLAG}}
      - echo "✓ HyperShift operator installed in namespace {{.HYPERSHIFT_NAMESPACE}}"

  install-with-external-dns:
    desc: Install HyperShift operator WITH External DNS (production mode)
    deps: [create-dns-secret]
    vars:
      IMAGE_FLAG: '{{if .HYPERSHIFT_IMAGE}}--hypershift-image={{.HYPERSHIFT_IMAGE}}{{end}}'
      NS_FLAG: '{{if ne .HYPERSHIFT_NAMESPACE "hypershift"}}--namespace={{.HYPERSHIFT_NAMESPACE}}{{end}}'
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: test -f {{.DNS_CREDS_FILE}}
        msg: "DNS credentials file not found at {{.DNS_CREDS_FILE}}"
      - sh: test -n "{{.PARENT_DNS_ZONE}}"
        msg: "PARENT_DNS_ZONE not set"
      - sh: command -v hypershift
        msg: "hypershift CLI not found"
    status:
      - oc get deployment operator -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
      - oc get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
    cmds:
      - echo "Installing HyperShift operator with External DNS..."
      - echo "  DNS Zone{{":"}} {{.EXTRN_DNS_ZONE_NAME}}"
      - hypershift install --external-dns-provider=azure --external-dns-credentials {{.DNS_CREDS_FILE}} --pull-secret {{.PULL_SECRET}} --external-dns-domain-filter {{.EXTRN_DNS_ZONE_NAME}} --limit-crd-install azure {{.IMAGE_FLAG}} {{.NS_FLAG}}
      - echo "✓ HyperShift operator and External DNS installed in namespace {{.HYPERSHIFT_NAMESPACE}}"

  # === VERIFICATION ===

  verify:
    desc: Verify HyperShift operator installation
    cmds:
      - echo "Verifying HyperShift operator installation..."
      - echo ""
      - echo "Pods in {{.HYPERSHIFT_NAMESPACE}} namespace{{":"}}"
      - oc get pods -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "Operator deployment{{":"}}"
      - oc get deployment operator -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "HyperShift CRDs{{":"}}"
      - oc get crd | grep hypershift.openshift.io
      - echo ""
      - echo "Operator logs (last 20 lines){{":"}}"
      - oc logs -n {{.HYPERSHIFT_NAMESPACE}} deployment/operator --tail=20 || echo "⚠ Operator not yet ready"
      - echo ""
      - echo "✓ HyperShift operator verification complete"

  verify-external-dns:
    desc: Verify External DNS installation
    preconditions:
      - sh: oc get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
        msg: "External DNS deployment not found - did you install with External DNS?"
    cmds:
      - echo "Verifying External DNS..."
      - echo ""
      - echo "External DNS deployment{{":"}}"
      - oc get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "External DNS logs (last 20 lines){{":"}}"
      - oc logs -n {{.HYPERSHIFT_NAMESPACE}} deployment/external-dns --tail=20 || echo "⚠ External DNS not yet ready"
      - echo ""
      - echo "✓ External DNS verification complete"

  # === CLEANUP/UNINSTALLATION ===

  check-hosted-clusters:
    desc: Check for existing HostedCluster resources (safety check)
    preconditions:
      - sh: '[ $(oc get hostedclusters --all-namespaces -o name 2>/dev/null | wc -l) -eq 0 ]'
        msg: |
          ❌ WARNING: HostedCluster resources exist!

          View them with:
            oc get hostedclusters --all-namespaces

          Delete all hosted clusters before uninstalling the operator!
    cmds:
      - echo "✓ No HostedCluster resources found - safe to uninstall"

  uninstall:
    internal: true
    desc: Uninstall HyperShift operator (for installations WITHOUT External DNS)
    deps: [check-hosted-clusters]
    vars:
      IMAGE_FLAG: '{{if .HYPERSHIFT_IMAGE}}--hypershift-image={{.HYPERSHIFT_IMAGE}}{{end}}'
      NS_FLAG: '{{if ne .HYPERSHIFT_NAMESPACE "hypershift"}}--namespace={{.HYPERSHIFT_NAMESPACE}}{{end}}'
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: '! oc get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null'
        msg: |
          ❌ External DNS deployment detected!

          This installation includes External DNS.
          Use: task mgmt-cluster:cleanup-with-dns
    cmds:
      - echo "⚠ Uninstalling HyperShift operator from namespace {{.HYPERSHIFT_NAMESPACE}}..."
      - hypershift install render --pull-secret {{.PULL_SECRET}} --limit-crd-install azure {{.IMAGE_FLAG}} {{.NS_FLAG}} | oc delete --ignore-not-found -f -
      - echo "✓ HyperShift operator uninstalled"
      - echo "Note{{":"}} CRDs remain installed (to prevent accidental data loss)"

  uninstall-with-external-dns:
    internal: true
    desc: Uninstall HyperShift operator WITH External DNS
    deps: [check-hosted-clusters]
    vars:
      IMAGE_FLAG: '{{if .HYPERSHIFT_IMAGE}}--hypershift-image={{.HYPERSHIFT_IMAGE}}{{end}}'
      NS_FLAG: '{{if ne .HYPERSHIFT_NAMESPACE "hypershift"}}--namespace={{.HYPERSHIFT_NAMESPACE}}{{end}}'
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: test -f {{.DNS_CREDS_FILE}}
        msg: |
          ❌ DNS credentials file not found at {{.DNS_CREDS_FILE}}

          This file is required to properly uninstall External DNS.

          Options if you've lost this file{{":"}}
          1. Recreate it from the service principal (if credentials available)
          2. Manual cleanup{{":"}} oc delete namespace {{.HYPERSHIFT_NAMESPACE}}
    cmds:
      - echo "⚠ Uninstalling HyperShift operator with External DNS from namespace {{.HYPERSHIFT_NAMESPACE}}..."
      - hypershift install render --external-dns-provider=azure --external-dns-credentials {{.DNS_CREDS_FILE}} --pull-secret {{.PULL_SECRET}} --external-dns-domain-filter {{.EXTRN_DNS_ZONE_NAME}} --limit-crd-install azure {{.IMAGE_FLAG}} {{.NS_FLAG}} | oc delete --ignore-not-found -f -
      - echo "✓ HyperShift operator and External DNS uninstalled"
      - echo "Note{{":"}} CRDs remain installed (to prevent accidental data loss)"

  delete-dns-resources:
    desc: Delete External DNS resources
    cmds:
      - echo "Cleaning up External DNS resources..."
      - oc delete secret azure-config-file -n default --ignore-not-found
      - echo "✓ Deleted Kubernetes secret"
      - cmd: rm -f {{.DNS_CREDS_FILE}}
        ignore_error: true
      - echo "✓ Deleted local credentials file"
      - echo ""
      - echo "Note{{":"}} Service principal 'hypershift-external-dns-{{.PREFIX}}' still exists in Azure AD"
      - echo "Delete manually if no longer needed{{":"}}"
      - echo "  az ad sp delete --id \$(az ad sp list --display-name 'hypershift-external-dns-{{.PREFIX}}' --query '[0].appId' -o tsv)"

  # === ORCHESTRATION ===

  setup:
    desc: Complete management cluster setup (verify + install without External DNS)
    cmds:
      - task: verify-access
      - task: install
      - task: verify

  setup-with-dns:
    desc: Complete management cluster setup with External DNS (production)
    cmds:
      - task: verify-access
      - task: install-with-external-dns
      - task: verify
      - task: verify-external-dns

  cleanup:
    desc: Complete cleanup for installations WITHOUT External DNS
    cmds:
      - task: uninstall
      - task: delete-dns-resources
      - echo "✓ Cleanup complete"

  cleanup-with-dns:
    desc: Complete cleanup for installations WITH External DNS
    cmds:
      - task: uninstall-with-external-dns
      - task: delete-dns-resources
      - echo "✓ Cleanup complete"
