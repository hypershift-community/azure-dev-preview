version: '3'

vars:
  HYPERSHIFT_NAMESPACE: '{{.HYPERSHIFT_NAMESPACE | default "hypershift"}}'
  DNS_ZONE_RG: '{{.PERSISTENT_RG_NAME}}'
  EXTRN_DNS_ZONE_NAME: '{{.PARENT_DNS_ZONE}}'
  DNS_CREDS_FILE: 'azure_mgmt.json'

tasks:
  # === VERIFICATION ===

  verify-access:
    desc: Verify management cluster access and permissions
    cmds:
      - echo "Verifying management cluster access..."
      - kubectl cluster-info
      - |
        if kubectl auth can-i '*' '*' 2>/dev/null | grep -q "yes"; then
          echo "✓ Cluster-admin permissions confirmed"
        else
          echo "❌ Cluster-admin permissions required"
          exit 1
        fi

  check-capacity:
    desc: Check management cluster resource availability
    cmds:
      - echo "Checking node capacity..."
      - kubectl top nodes || echo "⚠ metrics-server not available"
      - echo ""
      - echo "Note{{":"}} Each hosted cluster needs approximately{{":"}}"
      - echo "  - 4 CPU cores"
      - echo "  - 8 GB memory"

  # === EXTERNAL DNS SETUP ===

  create-dns-sp:
    desc: Create service principal for External DNS
    internal: true
    preconditions:
      - sh: test -n "{{.PARENT_DNS_ZONE}}"
        msg: "PARENT_DNS_ZONE not set"
      - sh: test -n "{{.PERSISTENT_RG_NAME}}"
        msg: "PERSISTENT_RG_NAME not set"
      - sh: test -n "{{.SUBSCRIPTION_ID}}"
        msg: "SUBSCRIPTION_ID not set"
      - sh: test -n "{{.TENANT_ID}}"
        msg: "TENANT_ID not set"
    status:
      - test -f {{.DNS_CREDS_FILE}}
    cmds:
      - echo "Creating service principal for External DNS..."
      - |
        SP_DETAILS=$(az ad sp create-for-rbac \
          --name "hypershift-external-dns-{{.PREFIX}}" \
          --role "DNS Zone Contributor" \
          --scopes "/subscriptions/{{.SUBSCRIPTION_ID}}/resourceGroups/{{.DNS_ZONE_RG}}")

        cat > {{.DNS_CREDS_FILE}} <<EOF
        {
          "tenantId": "{{.TENANT_ID}}",
          "subscriptionId": "{{.SUBSCRIPTION_ID}}",
          "resourceGroup": "{{.DNS_ZONE_RG}}",
          "aadClientId": "$(echo "$SP_DETAILS" | jq -r '.appId')",
          "aadClientSecret": "$(echo "$SP_DETAILS" | jq -r '.password')"
        }
        EOF
        chmod 600 {{.DNS_CREDS_FILE}}
      - echo "✓ Created {{.DNS_CREDS_FILE}}"

  create-dns-secret:
    desc: Create Kubernetes secret for External DNS
    internal: true
    deps: [create-dns-sp]
    preconditions:
      - sh: test -f {{.DNS_CREDS_FILE}}
        msg: "DNS credentials file not found: {{.DNS_CREDS_FILE}}"
    cmds:
      - echo "Creating azure-config-file secret in default namespace..."
      - kubectl delete secret azure-config-file -n default --ignore-not-found
      - kubectl create secret generic azure-config-file -n default --from-file={{.DNS_CREDS_FILE}}
      - echo "✓ Created secret azure-config-file"

  # === OPERATOR INSTALLATION ===

  install:
    desc: Install HyperShift operator WITHOUT External DNS (simple mode)
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: command -v hypershift
        msg: "hypershift CLI not found"
    status:
      - kubectl get deployment operator -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
    cmds:
      - echo "Installing HyperShift operator (without External DNS)..."
      - |
        EXTRA_ARGS=""
        if [ -n "{{.HYPERSHIFT_IMAGE}}" ]; then
          EXTRA_ARGS="$EXTRA_ARGS --hypershift-image={{.HYPERSHIFT_IMAGE}}"
          echo "  Using custom operator image{{":"}} {{.HYPERSHIFT_IMAGE}}"
        fi
        if [ "{{.HYPERSHIFT_NAMESPACE}}" != "hypershift" ]; then
          EXTRA_ARGS="$EXTRA_ARGS --namespace={{.HYPERSHIFT_NAMESPACE}}"
        fi

        hypershift install \
          --pull-secret {{.PULL_SECRET}} \
          --limit-crd-install Azure \
          $EXTRA_ARGS
      - echo "✓ HyperShift operator installed in namespace {{.HYPERSHIFT_NAMESPACE}}"

  install-with-external-dns:
    desc: Install HyperShift operator WITH External DNS (production mode)
    deps: [create-dns-secret]
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: test -f {{.DNS_CREDS_FILE}}
        msg: "DNS credentials file not found at {{.DNS_CREDS_FILE}}"
      - sh: test -n "{{.PARENT_DNS_ZONE}}"
        msg: "PARENT_DNS_ZONE not set"
      - sh: command -v hypershift
        msg: "hypershift CLI not found"
    status:
      - kubectl get deployment operator -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
      - kubectl get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
    cmds:
      - echo "Installing HyperShift operator with External DNS..."
      - echo "  DNS Zone{{":"}} {{.EXTRN_DNS_ZONE_NAME}}"
      - |
        EXTRA_ARGS=""
        if [ -n "{{.HYPERSHIFT_IMAGE}}" ]; then
          EXTRA_ARGS="$EXTRA_ARGS --hypershift-image={{.HYPERSHIFT_IMAGE}}"
          echo "  Using custom operator image{{":"}} {{.HYPERSHIFT_IMAGE}}"
        fi
        if [ "{{.HYPERSHIFT_NAMESPACE}}" != "hypershift" ]; then
          EXTRA_ARGS="$EXTRA_ARGS --namespace={{.HYPERSHIFT_NAMESPACE}}"
        fi

        hypershift install \
          --external-dns-provider=azure \
          --external-dns-credentials {{.DNS_CREDS_FILE}} \
          --pull-secret {{.PULL_SECRET}} \
          --external-dns-domain-filter {{.EXTRN_DNS_ZONE_NAME}} \
          --limit-crd-install Azure \
          $EXTRA_ARGS
      - echo "✓ HyperShift operator and External DNS installed in namespace {{.HYPERSHIFT_NAMESPACE}}"

  # === VERIFICATION ===

  verify:
    desc: Verify HyperShift operator installation
    cmds:
      - echo "Verifying HyperShift operator installation..."
      - echo ""
      - echo "Pods in {{.HYPERSHIFT_NAMESPACE}} namespace{{":"}}"
      - kubectl get pods -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "Operator deployment{{":"}}"
      - kubectl get deployment operator -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "HyperShift CRDs{{":"}}"
      - kubectl get crd | grep hypershift.openshift.io
      - echo ""
      - echo "Operator logs (last 20 lines){{":"}}"
      - kubectl logs -n {{.HYPERSHIFT_NAMESPACE}} deployment/operator --tail=20 || echo "⚠ Operator not yet ready"
      - echo ""
      - echo "✓ HyperShift operator verification complete"

  verify-external-dns:
    desc: Verify External DNS installation
    preconditions:
      - sh: kubectl get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null
        msg: "External DNS deployment not found - did you install with External DNS?"
    cmds:
      - echo "Verifying External DNS..."
      - echo ""
      - echo "External DNS deployment{{":"}}"
      - kubectl get deployment external-dns -n {{.HYPERSHIFT_NAMESPACE}}
      - echo ""
      - echo "External DNS logs (last 20 lines){{":"}}"
      - kubectl logs -n {{.HYPERSHIFT_NAMESPACE}} deployment/external-dns --tail=20 || echo "⚠ External DNS not yet ready"
      - echo ""
      - echo "✓ External DNS verification complete"

  # === CLEANUP/UNINSTALLATION ===

  check-hosted-clusters:
    desc: Check for existing HostedCluster resources (safety check)
    silent: true
    cmds:
      - |
        CLUSTERS=$(kubectl get hostedclusters --all-namespaces -o name 2>/dev/null | wc -l)
        if [ "$CLUSTERS" -gt 0 ]; then
          echo "❌ WARNING{{":"}} Found $CLUSTERS HostedCluster resource(s)"
          echo ""
          kubectl get hostedclusters --all-namespaces
          echo ""
          echo "Delete all hosted clusters before uninstalling the operator!"
          exit 1
        fi
        echo "✓ No HostedCluster resources found - safe to uninstall"

  uninstall:
    desc: Uninstall HyperShift operator (WARNING - ensure clusters deleted first!)
    deps: [check-hosted-clusters]
    cmds:
      - echo "⚠ Uninstalling HyperShift operator from namespace {{.HYPERSHIFT_NAMESPACE}}..."
      - |
        if kubectl get namespace {{.HYPERSHIFT_NAMESPACE}} 2>/dev/null; then
          kubectl delete namespace {{.HYPERSHIFT_NAMESPACE}}
          echo "✓ Deleted namespace {{.HYPERSHIFT_NAMESPACE}}"
        else
          echo "Namespace {{.HYPERSHIFT_NAMESPACE}} not found - already deleted"
        fi

  delete-dns-resources:
    desc: Delete External DNS resources
    cmds:
      - echo "Cleaning up External DNS resources..."
      - kubectl delete secret azure-config-file -n default --ignore-not-found
      - echo "✓ Deleted Kubernetes secret"
      - cmd: rm -f {{.DNS_CREDS_FILE}}
        ignore_error: true
      - echo "✓ Deleted local credentials file"
      - echo ""
      - echo "Note{{":"}} Service principal 'hypershift-external-dns-{{.PREFIX}}' still exists in Azure AD"
      - echo "Delete manually if no longer needed{{":"}}"
      - echo "  az ad sp delete --id \$(az ad sp list --display-name 'hypershift-external-dns-{{.PREFIX}}' --query '[0].appId' -o tsv)"

  # === ORCHESTRATION ===

  setup:
    desc: Complete management cluster setup (verify + install without External DNS)
    cmds:
      - task: verify-access
      - task: install
      - task: verify

  setup-with-dns:
    desc: Complete management cluster setup with External DNS (production)
    cmds:
      - task: verify-access
      - task: install-with-external-dns
      - task: verify
      - task: verify-external-dns

  cleanup:
    desc: Complete cleanup (uninstall operator + delete DNS resources)
    cmds:
      - task: uninstall
      - task: delete-dns-resources
