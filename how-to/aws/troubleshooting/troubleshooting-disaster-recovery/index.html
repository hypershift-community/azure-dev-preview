
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Developer preview documentation for HyperShift on Azure">
      
      
        <meta name="author" content="HyperShift Community">
      
      
        <link rel="canonical" href="https://hypershift-community.github.io/azure-dev-preview/how-to/aws/troubleshooting/troubleshooting-disaster-recovery/">
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Debug Disaster Recovery - Hosted Cluster Migration - HyperShift Azure Developer Preview</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../custom.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#new-workloads-do-not-get-scheduled-in-the-new-migrated-cluster" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="HyperShift Azure Developer Preview" class="md-header__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HyperShift Azure Developer Preview
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Debug Disaster Recovery - Hosted Cluster Migration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../azure/self-managed/01-understanding/" class="md-tabs__link">
        
  
    
  
  Understanding

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../azure/self-managed/02-planning/" class="md-tabs__link">
        
  
    
  
  Planning

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../azure/self-managed/03-azure-foundation/" class="md-tabs__link">
        
  
    
  
  Azure Setup

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../azure/self-managed/04-management-cluster/" class="md-tabs__link">
          
  
    
  
  Management & Hosted Clusters

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../azure/self-managed/07-troubleshooting/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="HyperShift Azure Developer Preview" class="md-nav__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    HyperShift Azure Developer Preview
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/01-understanding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/02-planning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/03-azure-foundation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Management & Hosted Clusters
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Management & Hosted Clusters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/04-management-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Management Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/05-hosted-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create Hosted Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/06-day2-operations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Day 2 Operations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/07-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure/self-managed/08-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#new-workloads-do-not-get-scheduled-in-the-new-migrated-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      New workloads do not get scheduled in the new migrated cluster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-migration-gets-blocked-in-etcd-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      The migration gets blocked in ETCD recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-nodes-cannot-join-the-new-hosted-cluster-and-stay-in-the-older-one" class="md-nav__link">
    <span class="md-ellipsis">
      The nodes cannot join the new Hosted Cluster and stay in the older one
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The nodes cannot join the new Hosted Cluster and stay in the older one">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-pr-is-merged-and-my-hypershift-operator-has-that-code-running" class="md-nav__link">
    <span class="md-ellipsis">
      The PR is merged and my Hypershift Operator has that code running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-pr-is-not-merged-or-my-hypershift-operator-does-not-have-that-code-running" class="md-nav__link">
    <span class="md-ellipsis">
      The PR is not merged or my Hypershift Operator does not have that code running
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependent-resources-block-the-old-hosted-cluster-teardown" class="md-nav__link">
    <span class="md-ellipsis">
      Dependent resources block the old Hosted Cluster teardown
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-storage-clusteroperator-keeps-reporting-waiting-for-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      The Storage ClusterOperator keeps reporting "Waiting for Deployment"
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-image-registry-clusteroperator-keeps-reporting-a-degraded-status" class="md-nav__link">
    <span class="md-ellipsis">
      The image-registry ClusterOperator keeps reporting a degraded status
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="debug-disaster-recovery-hosted-cluster-migration">Debug Disaster Recovery - Hosted Cluster Migration</h1>
<p>These are issues related to disaster recovery that we've identified, and you could face during a Hosted Cluster migration.</p>
<h2 id="new-workloads-do-not-get-scheduled-in-the-new-migrated-cluster">New workloads do not get scheduled in the new migrated cluster</h2>
<p>Everything looks normal, in the destination Management or Hosted Cluster and in the old Management and Hosted Cluster, but your new workloads do not schedule in your migrated Hosted Cluster (your old ones should work properly).</p>
<p>Eventually your pods begin to fall down and the cluster status becomes degraded.</p>
<ol>
<li>
<p>First thing you need to check is the cluster operators and validate all of them work properly:
<div class="highlight"><pre><span></span><code>oc get co
</code></pre></div></p>
</li>
<li>
<p>If there are some of them degraded and with errors, please check the logs and validate things point to an OVN issue.
<div class="highlight"><pre><span></span><code>oc get co &lt;Operator&#39;s Name&gt; -o yaml
</code></pre></div></p>
</li>
<li>
<p>To solve the issue, we need to ensure the old Hosted Cluster is in pause (<a href="https://github.com/openshift/hypershift/pull/2265">we also need this</a>) or deleted.</p>
</li>
<li>
<p>Now we need to delete the OVN pods
<div class="highlight"><pre><span></span><code>oc --kubeconfig=${HC_KUBECONFIG} delete pod -n openshift-ovn-kubernetes --all
</code></pre></div></p>
</li>
</ol>
<p>Eventually the Hosted Cluster will start self healing and the ClusterOperator will come back.</p>
<p><strong>Cause:</strong> The cause of this issue is after the Hosted Cluster Migration the KAS (Kube API Server) uses the same DNS name, but it points to different load balancer in AWS platform. Sometimes OVN does not behave correctly facing this situation.</p>
<h2 id="the-migration-gets-blocked-in-etcd-recovery">The migration gets blocked in ETCD recovery</h2>
<p>The context around it's basically "I've edited the Hosted Cluster adding the <code>ETCDSnapshotURL</code> but the modification disappears and does not continue".</p>
<p>The first symptom is the status of the Hypershift Operator pod, in this case the pod is usually in <code>CrashLoopBackOff</code> status.</p>
<p>To solve this issue we need to:</p>
<ol>
<li>
<p>Kill the Hypershift Operator pod
<div class="highlight"><pre><span></span><code>oc delete pod -n hypershift -lapp=operator
</code></pre></div></p>
</li>
<li>
<p>Continue editing the HostedCluster, in order to add the <code>ETCDSnapshotURL</code> to the Hosted Cluster spec.</p>
</li>
<li>
<p>Now the ETCD pod will raise up using the snapshot from S3 bucket.</p>
</li>
</ol>
<p><strong>Cause:</strong> This issue happens when the Hypershift operator is down and the Hosted Cluster controller cannot handle the modifications in the objects which belong to it.</p>
<h2 id="the-nodes-cannot-join-the-new-hosted-cluster-and-stay-in-the-older-one">The nodes cannot join the new Hosted Cluster and stay in the older one</h2>
<p>We have 2 paths to follow, and it depends on if <a href="https://github.com/openshift/hypershift/pull/2265">this code</a> is in your Hypershift Operator.</p>
<h3 id="the-pr-is-merged-and-my-hypershift-operator-has-that-code-running">The PR is merged and my Hypershift Operator has that code running</h3>
<p>If that's the case, you need to make sure your Hosted Cluster is paused:
<div class="highlight"><pre><span></span><code>oc get hostedcluster -n &lt;HC Namespace&gt; &lt;HC Name&gt; -ojsonpath={.Spec.pausedUntil}
</code></pre></div></p>
<p>If this command does not give you any output, make sure you've followed properly the "<a href="https://hypershift-docs.netlify.app/how-to/aws/disaster-recovery/">Disaster Recovery</a>" procedure, more concretelly pausing the Hosted Cluster and NodePool.</p>
<p>Even if it's paused and is still in that situation, please <strong>continue to the next section</strong> because it's highly probable that you don't have the code which manages this situation properly.</p>
<h3 id="the-pr-is-not-merged-or-my-hypershift-operator-does-not-have-that-code-running">The PR is not merged or my Hypershift Operator does not have that code running</h3>
<p>If that's not the case, the only way to solve it is executing the teardown of the old Hosted Cluster prior the full restoration in the new Management cluster. Make sure you already have all the Manifests and the ETCD backed up.</p>
<p>Once you followed the Teardown procedure of the old Hosted Cluster, you will see how the migrated Hosted Cluster begins to self-recover.</p>
<p><strong>Cause:</strong> This issue occurs when the old Hosted Cluster has a conflict with the AWSPrivateLink object. The old one is still running and the new one cannot handle it because the <code>hypershift.local</code> AWS internal DNS entry still points to the old LoadBalancer.</p>
<h2 id="dependent-resources-block-the-old-hosted-cluster-teardown">Dependent resources block the old Hosted Cluster teardown</h2>
<p>To solve this issue you need to check all the objects in the HostedControlPlane Namespace and make sure all of them are being terminated. To do that we recommend to use an external tool called <a href="https://github.com/corneliusweig/ketall">ketall</a> which gives you a complete overview of all resources in a kubernetes cluster.</p>
<p>You need to know what object is preventing the Hosted Cluster from being deleted and ensure that the finalizer finishes successfully.</p>
<p>If you don't care about the stability of the old Management cluster, this script could help you to delete all the components in the <strong>HostedControlPlane Namespace</strong> (you need the ketall tool):</p>
<div class="highlight"><pre><span></span><code>#!/bin/bash

####
# Execution sample:
# ./delete_ns.sh $NAMESPACE
####

NAMESPACE=$1

if [[ -z $1 ]];then
        echo &quot;Specify the Namespace!&quot;
        exit 1
fi

for object in $(ketall -n $NAMESPACE -o name | grep -v packa)
do
    oc -n $NAMESPACE patch $object -p &#39;{&quot;metadata&quot;:{&quot;finalizers&quot;:null}}&#39; --type merge
done
</code></pre></div>
<p>Eventually, the namespace will be successfully terminated and also the Hosted Cluster.</p>
<p><strong>Cause:</strong> This is pretty common issue in the Kubernetes/Openshift world. You are trying to delete a resource that has other dependedent objects. The finalizer is still trying to delete them but it cannot progress.</p>
<h2 id="the-storage-clusteroperator-keeps-reporting-waiting-for-deployment">The Storage ClusterOperator keeps reporting "Waiting for Deployment"</h2>
<p>To solve this issue you need to check that all the pods from the <strong>HostedCluster</strong> and the <strong>HostedControlPlane</strong> are running, not blocked and there are no issues in the <code>cluster-storage-operator</code> pod. After that you need to delete the <strong>AWS EBS CSI Drivers</strong> from the HCP namespace in the destination management cluster:</p>
<ul>
<li>Delete the AWS EBS CSI Drivers deployments
<div class="highlight"><pre><span></span><code>oc delete aws-ebs-csi-driver-controller aws-ebs-csi-driver-operator
</code></pre></div></li>
</ul>
<p>The operator will take a while to raise up again and eventually the driver controller will be deployed by the <code>aws-ebs-csi-driver-operator</code>.</p>
<p><strong>Cause:</strong> This issue probably comes from objects that are deployed by the Operator. In this case, <code>cluster-storage-operator</code>, but the controller or the operator does not reconcile over them. If you delete the deployments, you ensure the operator is recreated from scratch.</p>
<h2 id="the-image-registry-clusteroperator-keeps-reporting-a-degraded-status">The image-registry ClusterOperator keeps reporting a degraded status</h2>
<p>When a migration is done and the image-registry clusteroperator is marked as degraded, you will need to figure out how it reaches that status. The message will look like <code>ImagePrunerDegraded: Job has reached the specified backoff limit</code>.</p>
<p>Things we need to review:</p>
<ul>
<li>Look for failure pods in the HostedControlPlane namespace at the destination management cluster.</li>
<li>Check the other Cluster operators in the HostedCluster.</li>
<li>Check if the nodes are ready and working fine in the HostedCluster.</li>
</ul>
<p>If all three components are working fine, the issue is in the backoff times of the executed job <code>image-pruner-XXXX</code>; this job has most likely failed. Once the migrated cluster has already converged and looks fine, you will need to make sure to fix this cluster operator manually; you will need to determine if you want immediate resolution, or you can wait 24h and the cronjob will raise up another job by itself.</p>
<p>To solve it manually, you need to:</p>
<ul>
<li>Reexecute the job <code>image-pruner-xxxx</code> from the <code>openshift-image-registry</code> namespace, using a cronjob called <code>image-pruner</code>
<div class="highlight"><pre><span></span><code>oc create job -n openshift-image-registry --from=cronjob/image-pruner image-pruner-recover
</code></pre></div></li>
</ul>
<p>This command creates a new job in that namespace and eventually will report the new status to the cluster operator.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.indexes", "content.code.annotate"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>