
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Developer preview documentation for HyperShift on Azure">
      
      
        <meta name="author" content="HyperShift Community">
      
      
        <link rel="canonical" href="https://hypershift-community.github.io/azure-dev-preview/how-to/aws/create-aws-hosted-cluster-autonode/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Create AutoNode hosted clusters - HyperShift Azure Developer Preview</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prerequisites" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HyperShift Azure Developer Preview" class="md-header__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HyperShift Azure Developer Preview
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Create AutoNode hosted clusters
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/01-understanding/" class="md-tabs__link">
        
  
    
  
  Understanding

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/02-planning/" class="md-tabs__link">
        
  
    
  
  Planning

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/03-azure-foundation/" class="md-tabs__link">
        
  
    
  
  Azure Setup

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure/self-managed/04-management-cluster/" class="md-tabs__link">
          
  
    
  
  Management & Hosted Clusters

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure/self-managed/07-troubleshooting/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HyperShift Azure Developer Preview" class="md-nav__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    HyperShift Azure Developer Preview
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/01-understanding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/02-planning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/03-azure-foundation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Management & Hosted Clusters
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Management & Hosted Clusters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/04-management-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Management Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/05-hosted-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create Hosted Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/06-day2-operations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Day 2 Operations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/07-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/08-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-the-hypershift-operator" class="md-nav__link">
    <span class="md-ellipsis">
      Install the Hypershift Operator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-workload-cluster-with-autonode" class="md-nav__link">
    <span class="md-ellipsis">
      Create Workload Cluster with AutoNode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-sample-workloads" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Sample Workloads
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Sample Workloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-autonode-with-a-simple-web-app" class="md-nav__link">
    <span class="md-ellipsis">
      Using AutoNode with a Simple Web App
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Create AutoNode hosted clusters</h1>

<p>HyperShift AutoNode (Powered by Karpenter) is a feature that runs
Karpenter management side as a control plane component while it
watches <code>openshiftNodeClasses</code>, <code>nodePools.karpenter.sh</code>,
and <code>nodeclaims.karpenter.sh</code> resources in the guest cluster.</p>
<p>To create a hosted cluster with autoNode enabled the Hypershift Operator
needs to be installed with the <a href="https://hypershift-docs.netlify.app/how-to/feature-gates">feature gate <code>--tech-preview-no-upgrade=true</code></a>.</p>
<p>The Hypershift controller creates and manages the default <code>openshiftNodeClasses</code>
in the hosted cluster allowing you to deploy workloads based in
your environment with <a href="https://karpenter.sh/docs/concepts/nodepools/"><code>NodePools</code>(<code>nodepools.karpenter.sh</code>)</a>.</p>
<p>The following steps describes how to install OpenShift workload cluster
on AWS with AutoNode feature by Karpenter.</p>
<blockquote>
<p>Note: <code>openshiftNodeClasses</code> is exposed for <a href="https://github.com/openshift/hypershift/blob/892474ca2fd481eeab741da377d017051256914a/api/karpenter/v1beta1/karpenter_types.go#L53-L55">API consumers</a>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li><a href="https://hypershift-docs.netlify.app/getting-started/#prerequisites">Install the latest and greatest HyperShift CLI</a>.<ul>
<li>Make sure all prerequisites have been satisfied (Pull Secret, Hosted Zone, OIDC Bucket, etc)</li>
</ul>
</li>
<li>Ensure that the AWS service-linked role for Spot is enabled in the account where the hosted cluster will be installed. This is a one-time setup per account.<ul>
<li>You can verify if the role already exists using the following command:
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>get-role<span class="w"> </span>--role-name<span class="w"> </span>AWSServiceRoleForEC2Spot
</code></pre></div></li>
<li>If the role does not exist, create it with:
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-service-linked-role<span class="w"> </span>--aws-service-name<span class="w"> </span>spot.amazonaws.com
</code></pre></div></li>
</ul>
</li>
<li>Export environment variables, adjusting according to your setup:
<div class="highlight"><pre><span></span><code><span class="c1"># AWS config</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">AWS_CREDS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.aws/credentials&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">AWS_REGION</span><span class="o">=</span>us-east-1

<span class="c1"># OpenShift credentials and configuration</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CLUSTER_PREFIX</span><span class="o">=</span>hcp-aws
<span class="nb">export</span><span class="w"> </span><span class="nv">CLUSTER_BASE_DOMAIN</span><span class="o">=</span>devcluster.openshift.com
<span class="nb">export</span><span class="w"> </span><span class="nv">PULL_SECRET_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.openshift/pull-secret-latest.json&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SSH_PUB_KEY_FILE</span><span class="o">=</span><span class="nv">$HOME</span>/.ssh/id_rsa.pub

<span class="c1">## S3 Bucket name hosting the OIDC discovery documents</span>
<span class="c1"># You must have set it up, see Getting Started for more information:</span>
<span class="c1"># https://hypershift-docs.netlify.app/getting-started/</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OIDC_BUCKET_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER_PREFIX</span><span class="si">}</span><span class="s2">-oidc&quot;</span>
</code></pre></div></li>
</ul>
<h3 id="install-the-hypershift-operator">Install the Hypershift Operator</h3>
<p>This section describes hands on steps to install the Hypershift Operator with AutoNode feature by enabling the feature gate <code>tech-preview-no-upgrade</code>. See the following documents for more information:</p>
<ul>
<li><a href="https://hypershift-docs.netlify.app/getting-started/#install-hypershift-operator">Install HyperShift Operator</a></li>
<li><a href="https://hypershift-docs.netlify.app/how-to/feature-gates">Feature Gates</a></li>
</ul>
<p>Steps:</p>
<ul>
<li>
<p>Install the operator:
<div class="highlight"><pre><span></span><code>./hypershift<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--oidc-storage-provider-s3-bucket-name<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OIDC_BUCKET_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--oidc-storage-provider-s3-credentials<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AWS_CREDS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--oidc-storage-provider-s3-region<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AWS_REGION</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--tech-preview-no-upgrade<span class="o">=</span><span class="nb">true</span>
</code></pre></div></p>
</li>
<li>
<p>Check if controller is running as expected:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>hypershift
</code></pre></div>
<h2 id="create-workload-cluster-with-autonode">Create Workload Cluster with AutoNode</h2>
<p>Create the workload cluster with HyperShift AutoNode.</p>
<p>Choose the desired target release image name (<a href="https://openshift-release.apps.ci.l2s4.p1.openshiftapps.com/">release controller</a>).</p>
<p>Create a hosted cluster, enabling the flag <code>--auto-node</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">HOSTED_CLUSTER_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">CLUSTER_PREFIX</span><span class="si">}</span>-wl
<span class="nv">OCP_RELEASE_IMAGE</span><span class="o">=</span>&lt;CHANGE_ME_TO_LATEST_RELEASE_IMAGE&gt;
<span class="c1"># Example of image: quay.io/openshift-release-dev/ocp-release:4.19.0-rc.5-x86_64</span>

./hypershift<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>aws<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOSTED_CLUSTER_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--region<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AWS_REGION</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--zones<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AWS_REGION</span><span class="si">}</span><span class="s2">a&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--node-pool-replicas<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--base-domain<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER_BASE_DOMAIN</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--pull-secret<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PULL_SECRET_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--aws-creds<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AWS_CREDS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--ssh-key<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_PUB_KEY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--release-image<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCP_RELEASE_IMAGE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--auto-node<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>Check the cluster information:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>--namespace<span class="w"> </span>clusters<span class="w"> </span>hostedclusters
oc<span class="w"> </span>get<span class="w"> </span>--namespace<span class="w"> </span>clusters<span class="w"> </span>nodepools
</code></pre></div>
<p>When completed, extract the credentials for workload cluster:</p>
<div class="highlight"><pre><span></span><code>./hypershift<span class="w"> </span>create<span class="w"> </span>kubeconfig<span class="w"> </span>--name<span class="w"> </span><span class="si">${</span><span class="nv">HOSTED_CLUSTER_NAME</span><span class="si">}</span><span class="w"> </span>&gt;<span class="w"> </span>kubeconfig-<span class="si">${</span><span class="nv">HOSTED_CLUSTER_NAME</span><span class="si">}</span>

<span class="c1"># kubeconfig for workload cluster</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$PWD</span>/kubeconfig-<span class="si">${</span><span class="nv">HOSTED_CLUSTER_NAME</span><span class="si">}</span>
</code></pre></div>
<p>Check the managed <code>openshiftNodeClasses</code> object created in the workload cluster:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>openshiftNodeClasses
</code></pre></div>
<p>Now you are ready to use AutoNode feature by setting the Karpenter configuration to fit your workloads.</p>
<h2 id="deploy-sample-workloads">Deploy Sample Workloads</h2>
<p>This section provides examples to getting started exploring HyperShift AutoNode.</p>
<h3 id="using-autonode-with-a-simple-web-app">Using AutoNode with a Simple Web App</h3>
<p>This example demonstrates how to use the AutoNode feature by creating a NodePool
to fit the sample application. The sample application selects the
instance type <code>t3.large</code>, matching the <code>node.kubernetes.io/instance-type</code>
selector in the <code>NodePool</code>.</p>
<p>Create a Karpenter NodePool with the configuration for the workload:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | oc apply -f -</span>
<span class="s">apiVersion: karpenter.sh/v1</span>
<span class="s">kind: NodePool</span>
<span class="s">metadata:</span>
<span class="s"> name: spot-and-gpu</span>
<span class="s">spec:</span>
<span class="s">  disruption:</span>
<span class="s">    budgets:</span>
<span class="s">      - nodes: 10%</span>
<span class="s">    consolidateAfter: 30s</span>
<span class="s">    consolidationPolicy: WhenEmptyOrUnderutilized</span>
<span class="s">  weight: 10</span>
<span class="s">  template:</span>
<span class="s">    spec:</span>
<span class="s">      expireAfter: 336h</span>
<span class="s">      terminationGracePeriod: 24h0m0s</span>
<span class="s">      nodeClassRef:</span>
<span class="s">        group: karpenter.k8s.aws</span>
<span class="s">        kind: EC2NodeClass</span>
<span class="s">        name: default</span>
<span class="s">      requirements:</span>
<span class="s">      - key: karpenter.sh/capacity-type</span>
<span class="s">        operator: In</span>
<span class="s">        values: [&quot;spot&quot;]</span>
<span class="s">      - key: karpenter.sh/instance-family</span>
<span class="s">        operator: In</span>
<span class="s">        values: [&quot;g4dn&quot;, &quot;m5&quot;, &quot;m6i&quot;, &quot;c5&quot;, &quot;c6i&quot;, &quot;t3&quot;]</span>
<span class="s">      - key: karpenter.sh/instance-size</span>
<span class="s">        operator: In</span>
<span class="s">        values: [&quot;large&quot;, &quot;xlarge&quot;, &quot;2xlarge&quot;]</span>
<span class="s">EOF</span>
</code></pre></div>
<p><strong>Create a Sample App deployment:</strong></p>
<p>This section demonstrates how to deploy sample applications to test and scale Karpenter's AutoNode feature. By creating workloads with specific resource requirements, you can observe how Karpenter provisions nodes dynamically to meet the demands of your applications.</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | oc apply -f -</span>
<span class="s">---</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s"> name: web-app</span>
<span class="s">spec:</span>
<span class="s"> replicas: 0</span>
<span class="s"> selector:</span>
<span class="s">   matchLabels:</span>
<span class="s">     app: web-app</span>
<span class="s"> template:</span>
<span class="s">   metadata:</span>
<span class="s">     labels:</span>
<span class="s">       app: web-app</span>
<span class="s">   spec:</span>
<span class="s">     affinity:</span>
<span class="s">       podAntiAffinity:</span>
<span class="s">         requiredDuringSchedulingIgnoredDuringExecution:</span>
<span class="s">           - labelSelector:</span>
<span class="s">               matchLabels:</span>
<span class="s">                 app: web-app</span>
<span class="s">             topologyKey: &quot;kubernetes.io/hostname&quot;   </span>
<span class="s">     securityContext:</span>
<span class="s">       runAsUser: 1000</span>
<span class="s">       runAsGroup: 3000</span>
<span class="s">       fsGroup: 2000</span>
<span class="s">     containers:</span>
<span class="s">     - image: public.ecr.aws/eks-distro/kubernetes/pause:3.2</span>
<span class="s">       name: web-app</span>
<span class="s">       resources:</span>
<span class="s">         requests:</span>
<span class="s">           cpu: &quot;1&quot;</span>
<span class="s">           memory: 256M</span>
<span class="s">       securityContext:</span>
<span class="s">         allowPrivilegeEscalation: false</span>
<span class="s">     nodeSelector:</span>
<span class="s">       node.kubernetes.io/instance-type: &quot;t3.large&quot;</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Scale the application:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>scale<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span><span class="w"> </span>deployment.apps/web-app
</code></pre></div>
<p><strong>Monitor and Debug Node Provisioning with AutoNode:</strong></p>
<p>Monitor the <code>nodeClaims</code> objects to track the provisioning of nodes by AutoNode. These objects provide detailed insights into the lifecycle of nodes, including their current state and any associated events. Use the following command to continuously watch the <code>nodeClaims</code>:</p>
<div class="admonition warning">
<p class="admonition-title">Provisioning Time</p>
</div>
<p>The provisioning process for an instance to become a node may take approximately 10 minutes. While waiting, monitor the progress using the provided commands to ensure the process completes successfully.</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>nodeclaims<span class="w"> </span>--watch
</code></pre></div>
<p>To investigate a specific <code>nodeClaim</code> in detail, use the following command:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>describe<span class="w"> </span>nodeclaim<span class="w"> </span>&lt;nodeClaimName&gt;
</code></pre></div>
<p>This will provide comprehensive information about the selected <code>nodeClaim</code>, helping you debug and confirm that nodes are being provisioned and functioning as expected.</p>
<p><strong>Verify Node Join Status:</strong></p>
<p>Ensure that the node has successfully joined the cluster. Use the following command to check:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-l<span class="w"> </span>karpenter.sh/nodepool<span class="o">=</span>spot-and-gpu
</code></pre></div>
<p>This command filters the nodes associated with the <code>spot-and-gpu</code> NodePool, allowing you to confirm that the AutoNode feature is functioning as expected.</p>
<p><strong>Verify Application Scheduling:</strong></p>
<p>Ensure that the application has been successfully scheduled onto the newly provisioned node. Use the following command to check the status of the pods associated with the application:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>web-app<span class="w"> </span>-o<span class="w"> </span>wide
</code></pre></div>
<p>This command filters the pods by the label <code>app=web-app</code>, allowing you to confirm that the application is running on the expected node provisioned by AutoNode.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>