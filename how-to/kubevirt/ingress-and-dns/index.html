
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Developer preview documentation for HyperShift on Azure">
      
      
        <meta name="author" content="HyperShift Community">
      
      
        <link rel="canonical" href="https://hypershift-community.github.io/azure-dev-preview/how-to/kubevirt/ingress-and-dns/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Ingress and DNS configuration - HyperShift Azure Developer Preview</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#default-ingress-and-dns-behavior" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HyperShift Azure Developer Preview" class="md-header__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HyperShift Azure Developer Preview
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ingress and DNS configuration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/01-understanding/" class="md-tabs__link">
        
  
    
  
  Understanding

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/02-planning/" class="md-tabs__link">
        
  
    
  
  Planning

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../azure/self-managed/03-azure-foundation/" class="md-tabs__link">
        
  
    
  
  Azure Setup

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure/self-managed/04-management-cluster/" class="md-tabs__link">
          
  
    
  
  Management & Hosted Clusters

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure/self-managed/07-troubleshooting/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HyperShift Azure Developer Preview" class="md-nav__button md-logo" aria-label="HyperShift Azure Developer Preview" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    HyperShift Azure Developer Preview
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/01-understanding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/02-planning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/03-azure-foundation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Management & Hosted Clusters
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Management & Hosted Clusters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/04-management-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Management Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/05-hosted-cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create Hosted Cluster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/06-day2-operations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Day 2 Operations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/07-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure/self-managed/08-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#default-ingress-and-dns-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Default Ingress and DNS Behavior
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customized-ingress-and-dns-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Customized Ingress and DNS Behavior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Customized Ingress and DNS Behavior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-deploying-the-hostedcluster-specifying-our-base-domain" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1 - Deploying the HostedCluster specifying our base domain
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-set-up-the-loadbalancer" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 - Set up the LoadBalancer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-set-up-a-wildcard-dns-record-for-the-apps" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3 - Set up a wildcard DNS record for the *.apps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-hostedcluster-status-after-having-fixed-the-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      Checking HostedCluster status after having fixed the ingress
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-metallb-configuration-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Optional MetalLB Configuration Steps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ingress-and-dns-configuration">Ingress and DNS configuration</h1>
<p>By default, the HyperShift operator will configure the KubeVirt platform guest
cluster's ingress and DNS behavior to reuse what is provided by the underlying
infra cluster that the KubeVirt VMs are running on. This section describes
that default behavior in greater detail as well as information on advanced usage
options.</p>
<h2 id="default-ingress-and-dns-behavior">Default Ingress and DNS Behavior</h2>
<p>Every OpenShift cluster comes setup with a default application ingress
controller which is expected to have an wildcard DNS record associated with it.
By default, guest clusters created using the Hypershift KubeVirt provider
will automatically become a subdomain of the underlying OCP cluster that
the KubeVirt VMs run on.</p>
<p>For example, if an OCP cluster has a default ingress DNS entry of
<code>*.apps.mgmt-cluster.example.com</code>, then the default ingress of a KubeVirt
guest cluster named <code>guest</code> running on that underlying OCP cluster will
be <code>*.apps.guest.apps.mgmt-cluster.example.com</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this default ingress DNS to work properly, the underlying cluster
hosting the KubeVirt VMs must allow wildcard DNS routes. This can be
configured using the following cli command. <code>oc patch ingresscontroller -n openshift-ingress-operator default --type=json -p '[{ "op": "add", "path": "/spec/routeAdmission", "value": {wildcardPolicy: "WildcardsAllowed"}}]'</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using the default guest cluster ingress, connectivity is limited to HTTPS
traffic over port 443. Plain HTTP traffic over port 80 will be rejected. This
limitation only applies to the default ingress behavior and not the custom ingress
behavior where manual creation of an ingress LoadBalancer and DNS is performed.</p>
</div>
<h2 id="customized-ingress-and-dns-behavior">Customized Ingress and DNS Behavior</h2>
<p>In lieu of the default ingress and DNS behavior, it is also possible to
configure a Hypershift KubeVirt guest cluster with a unique base domain
at creation time. This option does require some manual configuration
steps during creation though.</p>
<p>This process involves three steps:</p>
<ol>
<li>Cluster creation</li>
<li>LoadBalancer creation</li>
<li>Wildcard DNS configuration</li>
</ol>
<h3 id="step-1-deploying-the-hostedcluster-specifying-our-base-domain">Step 1 - Deploying the HostedCluster specifying our base domain</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">CLUSTER_NAME</span><span class="o">=</span>example
<span class="nb">export</span><span class="w"> </span><span class="nv">PULL_SECRET</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/pull-secret&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MEM</span><span class="o">=</span><span class="s2">&quot;6Gi&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CPU</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">WORKER_COUNT</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">BASE_DOMAIN</span><span class="o">=</span>hypershift.lab

hcp<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>kubevirt<span class="w"> </span><span class="se">\</span>
--name<span class="w"> </span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span><span class="se">\</span>
--node-pool-replicas<span class="w"> </span><span class="nv">$WORKER_COUNT</span><span class="w"> </span><span class="se">\</span>
--pull-secret<span class="w"> </span><span class="nv">$PULL_SECRET</span><span class="w"> </span><span class="se">\</span>
--memory<span class="w"> </span><span class="nv">$MEM</span><span class="w"> </span><span class="se">\</span>
--cores<span class="w"> </span><span class="nv">$CPU</span><span class="w"> </span><span class="se">\</span>
--base-domain<span class="w"> </span><span class="nv">$BASE_DOMAIN</span>
</code></pre></div></td></tr></table></div>
<p>With above configuration we will end up having a HostedCluster with an ingress wildcard configured for <code>*.apps.example.hypershift.lab</code> (*.apps.&lt;hostedcluster_name&gt;.&lt;base_domain&gt;).</p>
<p>This time, the HostedCluster will not finish the deployment (will remain in <code>Partial</code> progress) as we saw in the previous section, since we have configured a base domain we need to make sure that the required DNS records and load balancer are in-place:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>--namespace<span class="w"> </span>clusters<span class="w"> </span>hostedclusters

NAME<span class="w">            </span>VERSION<span class="w">   </span>KUBECONFIG<span class="w">                       </span>PROGRESS<span class="w">   </span>AVAILABLE<span class="w">   </span>PROGRESSING<span class="w">   </span>MESSAGE
example<span class="w">                   </span>example-admin-kubeconfig<span class="w">         </span>Partial<span class="w">    </span>True<span class="w">        </span>False<span class="w">         </span>The<span class="w"> </span>hosted<span class="w"> </span>control<span class="w"> </span>plane<span class="w"> </span>is<span class="w"> </span>available
</code></pre></div></td></tr></table></div>
<p>If we access the HostedCluster this is what we will see:</p>
<div class="highlight"><pre><span></span><code>hcp<span class="w"> </span>create<span class="w"> </span>kubeconfig<span class="w"> </span>--name<span class="w"> </span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$CLUSTER_NAME</span>-kubeconfig
</code></pre></div>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>--kubeconfig<span class="w"> </span><span class="nv">$CLUSTER_NAME</span>-kubeconfig<span class="w"> </span>get<span class="w"> </span>co

NAME<span class="w">                                       </span>VERSION<span class="w">   </span>AVAILABLE<span class="w">   </span>PROGRESSING<span class="w">   </span>DEGRADED<span class="w">   </span>SINCE<span class="w">   </span>MESSAGE
console<span class="w">                                    </span><span class="m">4</span>.14.0<span class="w">    </span>False<span class="w">       </span>False<span class="w">         </span>False<span class="w">      </span>30m<span class="w">     </span>RouteHealthAvailable:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>GET<span class="w"> </span>route<span class="w"> </span><span class="o">(</span>https://console-openshift-console.apps.example.hypershift.lab<span class="o">)</span>:<span class="w"> </span>Get<span class="w"> </span><span class="s2">&quot;https://console-openshift-console.apps.example.hypershift.lab&quot;</span>:<span class="w"> </span>dial<span class="w"> </span>tcp:<span class="w"> </span>lookup<span class="w"> </span>console-openshift-console.apps.example.hypershift.lab<span class="w"> </span>on<span class="w"> </span><span class="m">172</span>.31.0.10:53:<span class="w"> </span>no<span class="w"> </span>such<span class="w"> </span>host
.
.
.
ingress<span class="w">                                    </span><span class="m">4</span>.14.0<span class="w">    </span>True<span class="w">        </span>False<span class="w">         </span>True<span class="w">       </span>28m<span class="w">     </span>The<span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="w"> </span>ingress<span class="w"> </span>controller<span class="w"> </span>reports<span class="w"> </span><span class="nv">Degraded</span><span class="o">=</span>True:<span class="w"> </span>DegradedConditions:<span class="w"> </span>One<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>other<span class="w"> </span>status<span class="w"> </span>conditions<span class="w"> </span>indicate<span class="w"> </span>a<span class="w"> </span>degraded<span class="w"> </span>state:<span class="w"> </span><span class="nv">CanaryChecksSucceeding</span><span class="o">=</span>False<span class="w"> </span><span class="o">(</span>CanaryChecksRepetitiveFailures:<span class="w"> </span>Canary<span class="w"> </span>route<span class="w"> </span>checks<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>default<span class="w"> </span>ingress<span class="w"> </span>controller<span class="w"> </span>are<span class="w"> </span>failing<span class="o">)</span>
</code></pre></div>
<p>In the next section we will fix that.</p>
<h3 id="step-2-set-up-the-loadbalancer">Step 2 - Set up the LoadBalancer</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your cluster is on bare-metal you may need MetalLB to be able to provision functional LoadBalancer services. Take a look at the section <a href="#optional-metallb-configuration-steps">Optional MetalLB Configuration Steps</a>.</p>
</div>
<p>This option requires configuring a new LoadBalancer service that routes to the KubeVirt VMs as well as assign a wildcard DNS entry to the LoadBalancer's IP address.</p>
<p>First, we need to create a LoadBalancer Service that routes ingress traffic to the KubeVirt VMs.</p>
<p>A NodePort Service exposing the HostedCluster ingress already exists, we will grab the NodePorts and create the LoadBalancer service targeting these ports.</p>
<ol>
<li>
<p>Grab NodePorts</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">HTTP_NODEPORT</span><span class="o">=</span><span class="k">$(</span>oc<span class="w"> </span>--kubeconfig<span class="w"> </span><span class="nv">$CLUSTER_NAME</span>-kubeconfig<span class="w"> </span>get<span class="w"> </span>services<span class="w"> </span>-n<span class="w"> </span>openshift-ingress<span class="w"> </span>router-nodeport-default<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&quot;http&quot;)].nodePort}&#39;</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HTTPS_NODEPORT</span><span class="o">=</span><span class="k">$(</span>oc<span class="w"> </span>--kubeconfig<span class="w"> </span><span class="nv">$CLUSTER_NAME</span>-kubeconfig<span class="w"> </span>get<span class="w"> </span>services<span class="w"> </span>-n<span class="w"> </span>openshift-ingress<span class="w"> </span>router-nodeport-default<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="k">)</span>
</code></pre></div>
</li>
<li>
<p>Create LoadBalancer Service</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span><span class="s">&lt;&lt; EOF | oc apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  labels:</span>
<span class="s">    app: $CLUSTER_NAME</span>
<span class="s">  name: $CLUSTER_NAME-apps</span>
<span class="s">  namespace: clusters-$CLUSTER_NAME</span>
<span class="s">spec:</span>
<span class="s">  ports:</span>
<span class="s">  - name: https-443</span>
<span class="s">    port: 443</span>
<span class="s">    protocol: TCP</span>
<span class="s">    targetPort: ${HTTPS_NODEPORT}</span>
<span class="s">  - name: http-80</span>
<span class="s">    port: 80</span>
<span class="s">    protocol: TCP</span>
<span class="s">    targetPort: ${HTTP_NODEPORT}</span>
<span class="s">  selector:</span>
<span class="s">    kubevirt.io: virt-launcher</span>
<span class="s">  type: LoadBalancer</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
</ol>
<h3 id="step-3-set-up-a-wildcard-dns-record-for-the-apps">Step 3 - Set up a wildcard DNS record for the <code>*.apps</code></h3>
<p>Now that we have the ingress exposed, next step is configure a wildcard DNS A record or CNAME that references the LoadBalancer Service's external IP.</p>
<ol>
<li>Get the external IP.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">EXTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>oc<span class="w"> </span>-n<span class="w"> </span>clusters-<span class="nv">$CLUSTER_NAME</span><span class="w"> </span>get<span class="w"> </span>service<span class="w"> </span><span class="nv">$CLUSTER_NAME</span>-apps<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class="k">)</span>
</code></pre></div>
<ol>
<li>Configure a wildcard <code>*.apps.&lt;hostedcluster_name\&gt;.&lt;base_domain\&gt;.</code> DNS entry referencing the IP stored in $EXTERNAL_IP that is routable both internally and externally of the cluster.</li>
</ol>
<p>For example, for the cluster used in this example and for an external ip value of <code>192.168.20.30</code> this is what DNS resolutions will look like:</p>
<div class="highlight"><pre><span></span><code>dig<span class="w"> </span>+short<span class="w"> </span>test.apps.example.hypershift.lab

<span class="m">192</span>.168.20.30
</code></pre></div>
<h3 id="checking-hostedcluster-status-after-having-fixed-the-ingress">Checking HostedCluster status after having fixed the ingress</h3>
<p>Now that we fixed the ingress, we should see our HostedCluster progress moved from <code>Partial</code> to <code>Completed</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>oc<span class="w"> </span>get<span class="w"> </span>--namespace<span class="w"> </span>clusters<span class="w"> </span>hostedclusters

NAME<span class="w">            </span>VERSION<span class="w">   </span>KUBECONFIG<span class="w">                       </span>PROGRESS<span class="w">    </span>AVAILABLE<span class="w">   </span>PROGRESSING<span class="w">   </span>MESSAGE
example<span class="w">         </span><span class="m">4</span>.14.0<span class="w">    </span>example-admin-kubeconfig<span class="w">         </span>Completed<span class="w">   </span>True<span class="w">        </span>False<span class="w">         </span>The<span class="w"> </span>hosted<span class="w"> </span>control<span class="w"> </span>plane<span class="w"> </span>is<span class="w"> </span>available
</code></pre></div></td></tr></table></div>
<h2 id="optional-metallb-configuration-steps">Optional MetalLB Configuration Steps</h2>
<p>LoadBalancer type services are required. If MetalLB is in use, here are some example steps
outlining how to configure MetalLB after <a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/networking_operators/metallb-operator#nw-metallb-installing-operator-cli_metallb-operator-install">installing MetalLB using CLI</a>.</p>
<ol>
<li>
<p>Create a MetalLB instance:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: metallb.io/v1beta1</span>
<span class="s">kind: MetalLB</span>
<span class="s">metadata:</span>
<span class="s">  name: metallb</span>
<span class="s">  namespace: metallb-system</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Create address pool with an available range of IP addresses within the node network:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: metallb.io/v1beta1</span>
<span class="s">kind: IPAddressPool</span>
<span class="s">metadata:</span>
<span class="s">  name: metallb</span>
<span class="s">  namespace: metallb-system</span>
<span class="s">spec:</span>
<span class="s">  addresses:</span>
<span class="s">  - 192.168.216.32-192.168.216.122</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Advertise the address pool using L2 protocol:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: metallb.io/v1beta1</span>
<span class="s">kind: L2Advertisement</span>
<span class="s">metadata:</span>
<span class="s">  name: l2advertisement</span>
<span class="s">  namespace: metallb-system</span>
<span class="s">spec:</span>
<span class="s">  ipAddressPools:</span>
<span class="s">   - metallb</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>