
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Developer preview documentation for HyperShift on Azure" name="description"/>
<meta content="HyperShift Community" name="author"/>
<link href="https://hypershift-community.github.io/azure-dev-preview/how-to/azure/create-azure-cluster-with-options/" rel="canonical"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.8" name="generator"/>
<title>Create an Azure cluster with Additional Options - HyperShift Azure Developer Preview</title>
<link href="../../../assets/stylesheets/main.8608ea7d.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
 <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="slate" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#prerequisites">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="HyperShift Azure Developer Preview" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="HyperShift Azure Developer Preview">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            HyperShift Azure Developer Preview
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Create an Azure cluster with Additional Options
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../self-managed/01-understanding/">
        
  
    
  
  Understanding

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../self-managed/02-planning/">
        
  
    
  
  Planning

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../self-managed/03-azure-foundation/">
        
  
    
  
  Azure Setup

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../self-managed/04-management-cluster/">
          
  
    
  
  Management &amp; Hosted Clusters

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../self-managed/07-troubleshooting/">
          
  
    
  
  Reference

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="HyperShift Azure Developer Preview" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="HyperShift Azure Developer Preview">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    HyperShift Azure Developer Preview
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/hypershift-community/azure-dev-preview" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    hypershift-community/azure-dev-preview
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/01-understanding/">
<span class="md-ellipsis">
    Understanding
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/02-planning/">
<span class="md-ellipsis">
    Planning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/03-azure-foundation/">
<span class="md-ellipsis">
    Azure Setup
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Management &amp; Hosted Clusters
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Management &amp; Hosted Clusters
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/04-management-cluster/">
<span class="md-ellipsis">
    Management Cluster
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/05-hosted-cluster/">
<span class="md-ellipsis">
    Create Hosted Cluster
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/06-day2-operations/">
<span class="md-ellipsis">
    Day 2 Operations
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Reference
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Reference
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/07-troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../self-managed/08-reference/">
<span class="md-ellipsis">
    Reference
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
<span class="md-ellipsis">
      Prerequisites
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encrypting-the-os-disks-on-azure-vms">
<span class="md-ellipsis">
      Encrypting the OS Disks on Azure VMs
    </span>
</a>
<nav aria-label="Encrypting the OS Disks on Azure VMs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cli-example">
<span class="md-ellipsis">
      CLI Example
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nodepool-cr-example">
<span class="md-ellipsis">
      NodePool CR Example
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#enabling-ephemeral-os-disks-on-azure-vms">
<span class="md-ellipsis">
      Enabling Ephemeral OS Disks on Azure VMs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#enabling-kms-encryption">
<span class="md-ellipsis">
      Enabling KMS encryption
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="create-an-azure-cluster-with-additional-options">Create an Azure cluster with Additional Options</h1>
<p>This document describes how to set up an Azure cluster with Hypershift with additional options.</p>
<p>Creating an Azure cluster with Hypershift without any additional flag options can be found <a href="../create-azure-cluster-on-aks/">here</a>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>All sections assume you are:
1. Using an AKS management cluster
2. Set up external DNS
3. Installed the HyperShift Operator</p>
<h2 id="encrypting-the-os-disks-on-azure-vms">Encrypting the OS Disks on Azure VMs</h2>
<p>There are a few prerequisites for encrypting the OS disks on the Azure VMs:</p>
<ol>
<li>Create your own resource group</li>
<li>Create an Azure Key Vault, with purge protection required, within the resource group</li>
<li>Create a key in the vault to use to create a DiskEncryptionSet</li>
<li>Create a DiskEncryptionSet with key in the vault and grant it permissions to assess the key vault</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will need to use the <code>resource-group-name</code> flag when using the <code>DiskEncryptionSetID</code> flag.</p>
</div>
<p>After performing these steps, you just need to provide the DiskEncryptionSet ID when creating a hosted cluster.</p>
<h3 id="cli-example">CLI Example</h3>
<div class="highlight"><pre><span></span><code>${HYPERSHIFT_BINARY_PATH}/hypershift create cluster azure \
--name "$CLUSTER_NAME" \
--azure-creds $AZURE_CREDS \
--location ${LOCATION} \
--node-pool-replicas 2 \
--base-domain $AZURE_BASE_DOMAIN \
--pull-secret $PULL_SECRET \
--generate-ssh \
--release-image ${RELEASE_IMAGE} \
--external-dns-domain ${MGMT_DNS_ZONE_NAME} \
--resource-group-name "${MANAGED_RG_NAME}" \
--vnet-id "${GetVnetID}" \
--subnet-id "${GetSubnetID}" \
--network-security-group-id "${GetNsgID}" \
--annotations hypershift.openshift.io/pod-security-admission-label-override=baseline \
--managed-identities-file ${SP_FILE} \
--assign-service-principal-roles \
--dns-zone-rg-name ${DNS_ZONE_RG_NAME} \
--fips=true \
--marketplace-publisher azureopenshift \
--marketplace-offer aro4 \
--marketplace-sku aro_417 \
--marketplace-version 417.94.20240701 \
--disk-encryption-set-id &lt;disk_encryption_set_id&gt;
</code></pre></div>
<p>You can also pass in the DiskEncryptionSet ID when creating a NodePool.</p>
<div class="highlight"><pre><span></span><code>hypershift create nodepool azure \
--name &lt;name_of_nodepool&gt; \
--cluster-name &lt;cluster_name&gt; \
--resource-group-name &lt;resource_group_name&gt; \
--disk-encryption-set-id &lt;disk_encryption_set_id&gt;
</code></pre></div>
<h3 id="nodepool-cr-example">NodePool CR Example</h3>
<p>The DiskEncryptionSet ID can also be set directly through the NodePool CR.</p>
<div class="highlight"><pre><span></span><code>apiVersion: hypershift.openshift.io/v1beta1
kind: NodePool
metadata:
  creationTimestamp: null
  name: &lt;nodepool_name&gt;
  namespace: clusters
spec:
  arch: amd64
  clusterName: &lt;cluster_name&gt;
  management:
    autoRepair: false
    upgradeType: Replace
  platform:
    azure:
      diskEncryptionSetID: &lt;disk_encryption_set_id&gt;
      diskSizeGB: 120
      vmsize: Standard_D4s_v4
    type: Azure
  release:
    image: &lt;release_image&gt;
  replicas: &lt;number_of_replicas&gt;
status:
  replicas: 0
</code></pre></div>
<h2 id="enabling-ephemeral-os-disks-on-azure-vms">Enabling Ephemeral OS Disks on Azure VMs</h2>
<p>To enable the ephemeral OS disk option on the Azure VMs in your HostedCluster, set the <code>enable-ephemeral-disk</code> flag to true.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Ephermeral OS disks are not available in every region or for every instance type.</p>
<p>You may need to adjust the disk storage account type; to adjust the disk storage account type,
use the <code>disk-storage-account-type</code> flag as shown in the example below.</p>
<p>You may need to adjust the disk size depending on the instance type used; to adjust the disk size, use the
<code>root-disk-size</code> flag.</p>
<p>See <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks">Ephemeral OS disks for Azure VMs</a> for more details.</p>
</div>
<div class="highlight"><pre><span></span><code>${HYPERSHIFT_BINARY_PATH}/hypershift create cluster azure \
--name "$CLUSTER_NAME" \
--azure-creds $AZURE_CREDS \
--location ${LOCATION} \
--node-pool-replicas 2 \
--base-domain $AZURE_BASE_DOMAIN \
--pull-secret $PULL_SECRET \
--generate-ssh \
--release-image ${RELEASE_IMAGE} \
--external-dns-domain ${MGMT_DNS_ZONE_NAME} \
--resource-group-name "${MANAGED_RG_NAME}" \
--vnet-id "${GetVnetID}" \
--subnet-id "${GetSubnetID}" \
--network-security-group-id "${GetNsgID}" \
--annotations hypershift.openshift.io/pod-security-admission-label-override=baseline \
--managed-identities-file ${MANAGED_IDENTITIES_FILE} \
--assign-service-principal-roles \
--dns-zone-rg-name ${DNS_ZONE_RG_NAME} \
--fips=true \
--marketplace-publisher azureopenshift \
--marketplace-offer aro4 \
--marketplace-sku aro_417 \
--marketplace-version 417.94.20240701 \
--enable-ephemeral-disk true \
--instance-type Standard_DS4_v2 \
--disk-storage-account-type Standard_LRS
</code></pre></div>
<p>You can also set the <code>enable-ephemeral-disk</code> flag when creating a NodePool.
<div class="highlight"><pre><span></span><code>hypershift create nodepool azure \
--name &lt;name_of_nodepool&gt; \
--cluster-name &lt;cluster_name&gt; \
--replicas &lt;number_of_replicas&gt; \
--release-image &lt;release_image&gt; \
--enable-ephemeral-disk true \
--instance-type Standard_DS4_v2 \
--disk-storage-account-type Standard_LRS
</code></pre></div></p>
<h2 id="enabling-kms-encryption">Enabling KMS encryption</h2>
<p>This section walks through how to:</p>
<ol>
<li>Set up a new resource group, key vault, and key for etcd encryption using KMSv2</li>
<li>Set up the role assignment between the KMS managed identity (MI) and the key vault</li>
<li>Set up the flags needed when creating the Azure HostedCluster</li>
<li>Verify the etcd encryption is setup and working properly </li>
</ol>
<p>There is a <code>setup_etcd_kv.sh</code> script in the contrib folder in the HyperShift repo to help automate the first couple of 
steps mentioned above. However, this guide will manually walk through those steps.</p>
<p>1a) Create a resource group for the key vault that will house the key used for etcd encryption. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is assumed this key vault is a different key vault, let's call it MI KV, than the one containing all of the 
managed identities for the control plane. However, the managed identity for KMS is assumed to be in the MI KV.</p>
</div>
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>example-kms<span class="w"> </span>--location<span class="w"> </span>eastus
</code></pre></div>
<p>1b) Create the etcd encryption key vault
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>keyvault<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>example-kms<span class="w"> </span>--resource-group<span class="w"> </span>example-kms<span class="w"> </span>--location<span class="w"> </span>eastus<span class="w"> </span>--enable-rbac-authorization
</code></pre></div></p>
<p>1c) Create a key in the etcd encryption key vault and capture the ID in a variable, KEY_ID. This will be passed when 
creating the Azure HostedCluster in a later step below.
<div class="highlight"><pre><span></span><code><span class="nv">KEY_ID</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>keyvault<span class="w"> </span>key<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vault-name<span class="w"> </span>example-kms<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>example-key<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--protection<span class="w"> </span>software<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--kty<span class="w"> </span>RSA<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query<span class="w"> </span>key.kid<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>tsv<span class="k">)</span>
</code></pre></div></p>
<p>2) Create a role assignment between the KMS MI and the resource group where the etcd encryption key vault is located so 
that it can encrypt &amp; decrypt objects.</p>
<div class="highlight"><pre><span></span><code><span class="nv">OBJECT_ID</span><span class="o">=</span><span class="s2">"the object ID of the KMS Managed Identity. This object ID can be found under the enterprise application for your KMS Managed Identity"</span>

az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span>--assignee<span class="w"> </span><span class="nv">$OBJECT_ID</span><span class="w"> </span>--role<span class="w"> </span><span class="s2">"Key Vault Crypto User"</span><span class="w"> </span><span class="se">\</span>
--scope<span class="w"> </span><span class="k">$(</span>az<span class="w"> </span>keyvault<span class="w"> </span>show<span class="w"> </span>--name<span class="w"> </span>example-kms<span class="w"> </span>--query<span class="w"> </span><span class="s2">"resourceGroup"</span><span class="w"> </span>-o<span class="w"> </span>tsv<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-I<span class="o">{}</span><span class="w"> </span>az<span class="w"> </span>group<span class="w"> </span>show<span class="w"> </span>--name<span class="w"> </span><span class="o">{}</span><span class="w"> </span>--query<span class="w"> </span><span class="s2">"id"</span><span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>
</code></pre></div>
<p>3) Add these flags to your HyperShift CLI command when creating the Azure HostedCluster. KEY_ID is from step 1d.
<div class="highlight"><pre><span></span><code>`--encryption-key-id $KEY_ID` \
`--kms-credentials-secret-name &lt;your KMS credentials secret name&gt;`
</code></pre></div></p>
<p>4) Here are some different things you can do to confirm etcd encryption using KMSv2 is set up properly on the 
HCP/HostedCluster:</p>
<p>First, confirm the kube-apiserver pod is using the <code>encryption-provider-config</code> flag such as:
<div class="highlight"><pre><span></span><code>--encryption-provider-config=/etc/kubernetes/secret-encryption/config.yaml 
</code></pre></div></p>
<p>If you look at this data, it should contain something like this:
<div class="highlight"><pre><span></span><code>apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- providers:
  - kms:
      apiVersion: v2
      endpoint: unix:///opt/azurekmsactive.socket
      name: azure-20514bc7
      timeout: 35s
  - identity: {}
  resources:
  - secrets
  - configmaps
  - routes.route.openshift.io
  - oauthaccesstokens.oauth.openshift.io
  - oauthauthorizetokens.oauth.openshift.io
</code></pre></div></p>
<p>Next, confirm the <code>azure-kms-provider-active</code> container in the kube-apiserver pod is running properly, there are no 
errors in the log, and the config file is using the KMS MI. The config file path can be found in the flag on the 
container spec:
<div class="highlight"><pre><span></span><code>--config-file-path=/etc/kubernetes/azure.json 
</code></pre></div></p>
<p>If you review this data, you should see the KMS MI credentials secret used within it.</p>
<p>Finally, you can create a secret on the HostedCluster and then check the secret on etcd in the etcd pod on the HCP 
directly:</p>
<p>1) Create a secret on the HostedCluster. Example <code>kubectl create secret generic kms-test --from-literal=foo=bar</code>.</p>
<p>2) Verify you can see the secret contents on the HostedCluster unencrypted.</p>
<p>3) Switch back to the AKS management cluster and exec into the etcd pod, <code>kubectl exec -it pod/etcd-0 -- /bin/bash</code>.</p>
<p>4) Run these commands in the etcd pod
<div class="highlight"><pre><span></span><code>export ETCDCTL_API=3
export ETCDCTL_CACERT=/etc/etcd/tls/etcd-ca/ca.crt
export ETCDCTL_CERT=/etc/etcd/tls/client/etcd-client.crt
export ETCDCTL_KEY=/etc/etcd/tls/client/etcd-client.key
export ETCDCTL_ENDPOINTS=https://etcd-client:2379
</code></pre></div>
5) Get the secret created on the HostedCluster <code>etcdctl get /kubernetes.io/secrets/default/kms-test</code>. You should see it 
is encrypted with KMSv2 by the azure provider:
<div class="highlight"><pre><span></span><code>k8s:enc:kms:v2:azure-8298bce7:
�d2%&amp;G
        E��k(�B�    �H�����6#�]�[���I
...
�=�s��h���Fq��a^(��z ��wIȫ�ݹ��,�բRa�A홟��5u�΀��*��᥃��ƚL�$L1Y'�V�Ӧi��.�   R�"                                            �
version.azure.akv.io1"&amp;
algorithm.azure.akv.io
                      RSA-OAEP-256(
</code></pre></div></p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
<script src="https://unpkg.com/mermaid@11.4.0/dist/mermaid.min.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>